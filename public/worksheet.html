<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worksheet Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Include the CSS styles from your original code */
        :root {
            --primary-color: #1a73e8;
            --primary-hover: #1765cc;
            --secondary-color: #f1f3f4;
            --border-color: #dadce0;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --white: #ffffff;
            --error-color: #d93025;
            --success-color: #188038;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
            color: var(--text-primary);
            background-color: var(--white);
            line-height: 1.5;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 8px 24px;
            border-bottom: 1px solid var(--border-color);
            height: 64px;
            position: sticky;
            top: 0;
            background-color: var(--white);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            margin-right: 24px;
        }

        .logo-img {
            height: 40px;
            margin-right: 8px;
        }

        .logo-text {
            color: var(--text-primary);
            font-size: 22px;
            font-weight: 500;
        }

        .nav {
            display: flex;
            flex-grow: 1;
        }

        .nav-item {
            margin-right: 16px;
            padding: 8px 12px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item.active {
            color: var(--primary-color);
            background-color: #e8f0fe;
        }

        .nav-item:hover {
            background-color: var(--secondary-color);
        }

        .user-menu {
            display: flex;
            align-items: center;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .container {
            max-width: 1200px;
            margin: 24px auto;
            padding: 0 24px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background-color: var(--secondary-color);
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            margin-right: 16px;
        }

        .back-btn:hover {
            background-color: #e5e7e9;
            transform: translateX(-2px);
        }

        .back-btn i {
            margin-right: 8px;
        }

        .card {
            background-color: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.1), 0 1px 3px 1px rgba(60,64,67,0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            transition: border 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px #e8f0fe;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235f6368'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
        }

        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background-color: #fafafa;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background-color: #f5f8ff;
        }

        .file-upload-icon {
            font-size: 48px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .file-upload-text {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-align: center;
        }

        .file-upload-hint {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .file-input {
            display: none;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            outline: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #e5e7e9;
        }

        .btn-icon {
            margin-right: 8px;
        }

        .preview-container {
            display: none;
            margin-top: 16px;
        }

        .preview-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .preview-content {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .results {
            display: none;
            margin-top: 32px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .results-actions {
            display: flex;
            gap: 8px;
        }

        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
        }

        .tab {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .worksheet-content {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            padding: 16px;
            background-color: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-height: 200px; /* Added for better visibility */
            /* Crucial for html2canvas to render correctly */
            position: relative; 
            overflow: hidden; /* Prevent content overflow issues during rendering */
        }

        .worksheet-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 16px;
            text-align: center;
        }

        .worksheet-instructions {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            text-align: center;
        }

        .question {
            margin-bottom: 20px;
            page-break-inside: avoid;
        }

        .question-text {
            font-weight: 500;
            margin-bottom: 8px;
        }

        .options {
            margin-left: 20px;
        }

        .option {
            margin-bottom: 4px;
        }

        .answer-key {
            font-family: 'Roboto', sans-serif;
            padding: 16px;
            background-color: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-height: 200px; /* Added for better visibility */
        }

        .answer-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed var(--border-color);
        }

        .answer-question {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .answer-correct {
            color: var(--success-color);
            font-weight: 500;
        }

        .modify-form {
            display: none;
            margin-top: 24px;
        }

        .modify-form.active {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 24px;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: var(--error-color);
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .footer {
            padding: 24px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .header {
                padding: 8px 16px;
            }

            .nav-item {
                padding: 8px;
                margin-right: 8px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .card {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <!-- <div class="logo">
            <img src="https://via.placeholder.com/40x40" alt="Oofle Logo" class="logo-img">
            <span class="logo-text">Oofle</span>
        </div> -->
        <div class="nav">
            <a href="#" class="nav-item">Home</a>
            <a href="#" class="nav-item active">Worksheet Generator</a>
            <!-- <a href="#" class="nav-item">Lesson Plans</a> -->
            <a href="#" class="nav-item">Resources</a>
        </div>
        <div class="user-menu">
            <div class="avatar">T</div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <div style="display: flex; align-items: center;">
                <button class="back-btn" onclick="goBackToIndex()">
                    <span class="material-icons">arrow_back</span>
                    Back to Dashboard
                </button>
                <h1 class="page-title">Worksheet Generator</h1>
            </div>
            <div>
                <button class="btn btn-secondary">
                    <span class="material-icons btn-icon">history</span>
                    View History
                </button>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Create New Worksheet</h2>
            <form id="worksheetForm">
                <div class="form-group">
                    <label for="sourceMaterial" class="form-label">Source Material</label>
                    <div class="file-upload" id="fileUploadArea">
                        <span class="material-icons file-upload-icon">cloud_upload</span>
                        <div class="file-upload-text">Upload textbook pages, lesson notes, or images</div>
                        <div class="file-upload-hint">Supports PDF, JPG, PNG, or text files</div>
                        <input type="file" id="sourceMaterial" class="file-input" accept=".pdf,.jpg,.jpeg,.png,.txt" multiple>
                    </div>
                    <div class="preview-container" id="previewContainer">
                        <div class="preview-title">Uploaded Files</div>
                        <div id="filePreviews"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="gradeLevel" class="form-label">Grade Level</label>
                    <select id="gradeLevel" class="form-control form-select" required>
                        <option value="">Select grade level</option>
                        <option value="kindergarten">Kindergarten</option>
                        <option value="elementary">Elementary (Grades 1-5)</option>
                        <option value="middle">Middle School (Grades 6-8)</option>
                        <option value="high">High School (Grades 9-12)</option>
                        <option value="college">College/University</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="subject" class="form-label">Subject</label>
                    <input type="text" id="subject" class="form-control" placeholder="e.g. Mathematics, History, Biology" required>
                </div>

                <div class="form-group">
                    <label for="topic" class="form-label">Topic</label>
                    <input type="text" id="topic" class="form-control" placeholder="e.g. Fractions, World War II, Photosynthesis" required>
                </div>

                <div class="form-group">
                    <label for="worksheetType" class="form-label">Worksheet Type</label>
                    <select id="worksheetType" class="form-control form-select" required>
                        <option value="">Select worksheet type</option>
                        <option value="multiple-choice">Multiple Choice</option>
                        <option value="short-answer">Short Answer</option>
                        <option value="fill-blank">Fill in the Blank</option>
                        <option value="matching">Matching</option>
                        <option value="true-false">True/False</option>
                        <option value="mixed">Mixed Questions</option>
                        <option value="essay">Essay Questions</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="difficulty" class="form-label">Difficulty Level</label>
                    <select id="difficulty" class="form-control form-select" required>
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="questionCount" class="form-label">Number of Questions</label>
                    <input type="number" id="questionCount" class="form-control" min="1" max="50" value="10" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Additional Options</label>
                    <div style="display: flex; gap: 16px;">
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="includeAnswerKey" checked style="margin-right: 8px;">
                            Include Answer Key
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" id="randomizeQuestions" style="margin-right: 8px;">
                            Randomize Questions
                        </label>
                    </div>
                </div>

                <div class="error-message" id="errorMessage"></div>

                <button type="submit" class="btn btn-primary">
                    <span class="material-icons btn-icon">auto_awesome</span>
                    Generate Worksheet
                </button>
            </form>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="loading-spinner"></div>
            <div>Generating your worksheet. This may take a moment...</div>
        </div>

        <div class="results" id="resultsContainer">
            <div class="results-header">
                <h2 class="page-title">Generated Worksheet</h2>
                <div class="results-actions">
                    <button class="btn btn-secondary" id="modifyBtn">
                        <span class="material-icons btn-icon">edit</span>
                        Modify
                    </button>
                    <button class="btn btn-primary" id="downloadPdfBtn">
                        <span class="material-icons btn-icon">download</span>
                        Download PDF
                    </button>
                </div>
            </div>

            <div class="modify-form" id="modifyForm">
                <div class="card">
                    <h2 class="card-title">Modify Worksheet</h2>
                    <div class="form-group">
                        <label for="modifyInstructions" class="form-label">Modification Instructions</label>
                        <textarea id="modifyInstructions" class="form-control" rows="3" placeholder="e.g. Make questions more difficult, focus more on chapter 3, add more multiple choice questions"></textarea>
                    </div>
                    <button class="btn btn-primary" id="submitModifications">
                        <span class="material-icons btn-icon">refresh</span>
                        Regenerate
                    </button>
                </div>
            </div>

            <div class="tab-container">
                <div class="tab active" data-tab="worksheet">Worksheet</div>
                <div class="tab" data-tab="answer-key">Answer Key</div>
                <div class="tab" data-tab="source-material">Source Material</div>
            </div>

            <div class="tab-content active" id="worksheet-tab">
                <div class="card">
                    <div class="worksheet-content" id="worksheetContent">
                        <p style="text-align: center; color: #666;">Your generated worksheet will appear here.</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="answer-key-tab">
                <div class="card">
                    <div class="answer-key" id="answerKeyContent">
                        <p style="text-align: center; color: #666;">The answer key will appear here after generation.</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="source-material-tab">
                <div class="card">
                    <div id="sourceMaterialContent">
                        <p style="text-align: center; color: #666;">Uploaded source material previews will appear here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>© 2023 Oofle Education. All rights reserved.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // IMPORTANT: Replace with your actual Gemini API Key.
            // For production, consider using a backend server to proxy API requests
            // to keep your API key secure and prevent abuse.
            const API_KEY = "AIzaSyDY7MB-brcUnm1eKTa0qqVJCMbNJ7SVgi0"; // <--- REMEMBER TO REPLACE THIS!
            const MODEL = "gemini-1.5-flash"; // gemini-1.5-pro is more capable but may have higher latency/cost
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;

            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('sourceMaterial');
            const previewContainer = document.getElementById('previewContainer');
            const filePreviews = document.getElementById('filePreviews');
            const worksheetForm = document.getElementById('worksheetForm');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultsContainer = document.getElementById('resultsContainer');
            const errorMessage = document.getElementById('errorMessage');
            const worksheetTabContent = document.getElementById('worksheetContent');
            const answerKeyTabContent = document.getElementById('answerKeyContent');
            const sourceMaterialTabContent = document.getElementById('sourceMaterialContent');

            fileUploadArea.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', async function() {
                if (fileInput.files.length > 0) {
                    previewContainer.style.display = 'block';
                    filePreviews.innerHTML = '';
                    sourceMaterialTabContent.innerHTML = ''; // Clear previous source material content

                    for (const file of Array.from(fileInput.files)) {
                        const filePreview = document.createElement('div');
                        filePreview.style.marginBottom = '8px';

                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.style.maxHeight = '100px';
                                img.style.maxWidth = '100%';
                                img.style.marginRight = '10px';
                                filePreview.appendChild(img);
                                sourceMaterialTabContent.appendChild(img.cloneNode(true)); // Add to source material tab
                            };
                            reader.readAsDataURL(file);
                        } else if (file.type === 'text/plain' || file.type === 'application/pdf') {
                            const fileNameSpan = document.createElement('span');
                            fileNameSpan.textContent = `${file.name} (${formatFileSize(file.size)})`;
                            filePreview.appendChild(fileNameSpan);

                            const reader = new FileReader();
                            reader.onload = function(e) {
                                // For PDF/TXT, display content preview in source material tab
                                const pre = document.createElement('pre');
                                // Limit preview to first 500 characters for large files
                                pre.textContent = e.target.result.substring(0, 500) + (e.target.result.length > 500 ? '...' : '');
                                pre.style.whiteSpace = 'pre-wrap';
                                pre.style.wordBreak = 'break-word';
                                pre.style.maxHeight = '200px'; // Limit height for preview
                                pre.style.overflowY = 'auto'; // Add scroll if content is too long
                                pre.style.border = '1px solid var(--border-color)';
                                pre.style.padding = '10px';
                                pre.style.borderRadius = '4px';
                                sourceMaterialTabContent.appendChild(pre);
                            };
                            reader.readAsText(file);
                        } else {
                            filePreview.textContent = `${file.name} (${formatFileSize(file.size)})`;
                        }
                        filePreviews.appendChild(filePreview);
                    }
                } else {
                    previewContainer.style.display = 'none';
                    sourceMaterialTabContent.innerHTML = '';
                }
            });

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });

            const modifyBtn = document.getElementById('modifyBtn');
            const modifyForm = document.getElementById('modifyForm');

            modifyBtn.addEventListener('click', function() {
                modifyForm.classList.toggle('active');
            });

            worksheetForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (fileInput.files.length === 0) {
                    errorMessage.textContent = 'Please upload at least one file as source material.';
                    errorMessage.style.display = 'block';
                    return;
                }

                errorMessage.style.display = 'none';
                loadingIndicator.style.display = 'block';
                resultsContainer.style.display = 'none';

                try {
                    const formData = {
                        gradeLevel: document.getElementById('gradeLevel').value,
                        subject: document.getElementById('subject').value,
                        topic: document.getElementById('topic').value,
                        worksheetType: document.getElementById('worksheetType').value,
                        difficulty: document.getElementById('difficulty').value,
                        questionCount: parseInt(document.getElementById('questionCount').value, 10),
                        includeAnswerKey: document.getElementById('includeAnswerKey').checked,
                        randomizeQuestions: document.getElementById('randomizeQuestions').checked,
                        files: Array.from(fileInput.files) // Pass files for processing
                    };

                    const worksheetContent = await generateWorksheetWithGemini(formData);

                    displayWorksheet(worksheetContent);

                    loadingIndicator.style.display = 'none';
                    resultsContainer.style.display = 'block';

                    resultsContainer.scrollIntoView({ behavior: 'smooth' });
                } catch (err) {
                    loadingIndicator.style.display = 'none';
                    errorMessage.textContent = `An error occurred while generating the worksheet: ${err.message}. Please check your API key and try again.`;
                    errorMessage.style.display = 'block';
                    console.error('Worksheet generation error:', err);
                }
            });

            /**
             * Converts a File object into a GenerativeContentPart for Gemini API.
             * Supports image types by converting to base64 inlineData.
             * For text files, it reads the text content.
             * For PDFs, it sends a placeholder instruction.
             * @param {File} file The File object to convert.
             * @returns {Promise<Object>} A promise that resolves to a Gemini API part object.
             */
            async function fileToGenerativePart(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        if (file.type.startsWith('image/')) {
                            resolve({
                                inlineData: {
                                    data: reader.result.split(',')[1], // Get base64 data after "data:image/png;base64,"
                                    mimeType: file.type,
                                },
                            });
                        } else if (file.type === 'text/plain') {
                            resolve({ text: `Source Text from ${file.name}:\n${reader.result}` });
                        } else if (file.type === 'application/pdf') {
                            // For PDFs, Gemini can sometimes understand content from the file stream itself,
                            // but for direct client-side upload as a 'part', it's best to either:
                            // 1. Extract text/images beforehand using a library (more complex client-side, easier server-side).
                            // 2. Send a prompt asking Gemini to "imagine" the content from a PDF.
                            // Here, we send a prompt that indicates a PDF was provided.
                            // For actual PDF content understanding, consider sending the PDF as a Blob to a backend
                            // which then uses a specialized PDF parser or Gemini's more direct PDF handling if available.
                            resolve({ text: `Content from PDF file "${file.name}". Please analyze the content of this document to generate the worksheet questions.` });
                        } else {
                            reject(new Error(`Unsupported file type: ${file.type}`));
                        }
                    };
                    reader.onerror = (error) => reject(error);

                    if (file.type.startsWith('image/')) {
                        reader.readAsDataURL(file); // Reads image as base64
                    } else if (file.type === 'text/plain' || file.type === 'application/pdf') {
                        reader.readAsText(file); // Reads text content for text files or attempts for PDF
                    } else {
                        reject(new Error("File type not supported for API upload directly."));
                    }
                });
            }






async function generateWorksheetWithGemini(formData, modificationInstructions = '') {
                const parts = [];

                // Add source material if available
                if (formData.files && formData.files.length > 0) {
                    for (const file of formData.files) {
                        try {
                            const generativePart = await fileToGenerativePart(file);
                            parts.push(generativePart);
                        } catch (e) {
                            console.error(`Error processing file ${file.name}:`, e);
                            parts.push({ text: `Note: Could not fully process source file "${file.name}" due to: ${e.message}. Please generate content based on other available information.` });
                        }
                    }
                }

                // Construct the main text prompt
                let textPrompt = `Generate a ${formData.worksheetType} worksheet on the topic of "${formData.topic}" for ${formData.gradeLevel} students in the subject of ${formData.subject}.`;
                textPrompt += `The worksheet should contain ${formData.questionCount} questions and be of ${formData.difficulty} difficulty.`;

                if (formData.randomizeQuestions) {
                    textPrompt += ` Randomize the order of questions.`;
                }

                if (formData.includeAnswerKey) {
                    textPrompt += `\nAlso, provide a separate answer key for the worksheet.`;
                    // **CRITICAL PROMPT REFINEMENT:** Be very explicit about valid JSON and escaping.
                    textPrompt += `\nFormat the output as a JSON object with two keys: "worksheet" (containing the worksheet content as plain text, with all newlines escaped as '\\n') and "answerKey" (containing the answer key content as plain text, with all newlines escaped as '\\n'). The JSON must be strictly valid, without any markdown code block wrappers (like \`\`\`json or \`\`\`).`;
                } else {
                    // **CRITICAL PROMPT REFINEMENT:** Be very explicit about valid JSON and escaping.
                    textPrompt += `\nFormat the output as a JSON object with one key: "worksheet" (containing the worksheet content as plain text, with all newlines escaped as '\\n'). The JSON must be strictly valid, without any markdown code block wrappers (like \`\`\`json or \`\`\`).`;
                }

                if (modificationInstructions) {
                    textPrompt += `\n\nApply the following modifications: "${modificationInstructions}"`;
                }
                
                parts.push({ text: textPrompt }); // Add the main text prompt as a part

                const requestBody = {
                    contents: [{
                        parts: parts // This array now contains text and potentially image data
                    }],
                    generationConfig: {
                        temperature: 0.7, // Adjust for creativity vs. factual accuracy
                        maxOutputTokens: 2000,
                    }
                };

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error Response:', errorData);
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                console.log('Gemini API raw response:', data);

                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    let responseText = data.candidates[0].content.parts[0].text;

                    // --- START OF CRITICAL FIX: Robust Pre-parsing Cleanup ---
                    // 1. Trim leading/trailing whitespace, including newlines.
                    responseText = responseText.trim();

                    // 2. Remove markdown code block wrappers (more general check)
                    if (responseText.startsWith('```json')) {
                        responseText = responseText.substring(7, responseText.length - 3).trim();
                    } else if (responseText.startsWith('```')) { // General markdown block (e.g., if it emits just "```\n{...}\n```")
                        responseText = responseText.substring(3, responseText.length - 3).trim();
                    }
                    // --- END OF CRITICAL FIX ---


                    try {
                        const parsedResponse = JSON.parse(responseText);
                        // The formatTextForHtml will be applied to these values in displayWorksheet
                        return parsedResponse; // Expecting { worksheet: "...", answerKey: "..." }
                    } catch (parseError) {
                        console.warn("Could not parse Gemini response as JSON. Displaying raw text.", responseText, parseError);
                        // Fallback in case JSON parsing fails completely, just show raw text nicely
                        return { 
                            worksheet: `<div style="padding: 15px; border: 1px dashed #ccc; background-color: #f9f9f9;">
                                            <p style="font-weight: bold; color: #d93025;">Error: Could not parse worksheet content.</p>
                                            <p>The AI might have returned malformed JSON. Raw response:</p>
                                            <pre style="white-space: pre-wrap; word-break: break-all;">${responseText}</pre>
                                        </div>`, 
                            answerKey: '<p style="text-align: center; color: #666;">Answer key unavailable due to content parsing error.</p>' 
                        };
                    }
                } else {
                    throw new Error("No content or unexpected format found in Gemini API response.");
                }
            }





            // async function generateWorksheetWithGemini(formData, modificationInstructions = '') {
            //     const parts = [];

            //     // Add source material if available
            //     if (formData.files && formData.files.length > 0) {
            //         for (const file of formData.files) {
            //             try {
            //                 const generativePart = await fileToGenerativePart(file);
            //                 parts.push(generativePart);
            //             } catch (e) {
            //                 console.error(`Error processing file ${file.name}:`, e);
            //                 // Optionally, add a text part indicating a file couldn't be processed
            //                 parts.push({ text: `Note: Could not fully process source file "${file.name}" due to: ${e.message}. Please generate content based on other available information.` });
            //             }
            //         }
            //     }

            //     // Construct the main text prompt
            //     let textPrompt = `Generate a ${formData.worksheetType} worksheet on the topic of "${formData.topic}" for ${formData.gradeLevel} students in the subject of ${formData.subject}.`;
            //     textPrompt += `The worksheet should contain ${formData.questionCount} questions and be of ${formData.difficulty} difficulty.`;

            //     if (formData.randomizeQuestions) {
            //         textPrompt += ` Randomize the order of questions.`;
            //     }

            //     if (formData.includeAnswerKey) {
            //         textPrompt += `\nAlso, provide a separate answer key for the worksheet.`;
            //         // Explicitly ask for HTML within the JSON, and no markdown wrappers.
            //         textPrompt += `\nFormat the output as a JSON object with two keys: "worksheet" (containing the worksheet content as clean HTML without any initial backticks or JSON wrapper, just the HTML for the body of the worksheet) and "answerKey" (containing the answer key content as clean HTML).`;
            //     } else {
            //         // Explicitly ask for HTML within the JSON, and no markdown wrappers.
            //         textPrompt += `\nFormat the output as a JSON object with one key: "worksheet" (containing the worksheet content as clean HTML without any initial backticks or JSON wrapper, just the HTML for the body of the worksheet).`;
            //     }

            //     if (modificationInstructions) {
            //         textPrompt += `\n\nApply the following modifications: "${modificationInstructions}"`;
            //     }
                
            //     parts.push({ text: textPrompt }); // Add the main text prompt as a part

            //     const requestBody = {
            //         contents: [{
            //             parts: parts // This array now contains text and potentially image data
            //         }],
            //         generationConfig: {
            //             temperature: 0.7, // Adjust for creativity vs. factual accuracy
            //             maxOutputTokens: 2000,
            //         }
            //     };

            //     const response = await fetch(GEMINI_API_URL, {
            //         method: 'POST',
            //         headers: {
            //             'Content-Type': 'application/json',
            //         },
            //         body: JSON.stringify(requestBody)
            //     });

            //     if (!response.ok) {
            //         const errorData = await response.json();
            //         console.error('API Error Response:', errorData);
            //         throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || JSON.stringify(errorData)}`);
            //     }

            //     const data = await response.json();
            //     console.log('Gemini API raw response:', data);

            //     if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
            //         let responseText = data.candidates[0].content.parts[0].text;

            //         // Attempt to clean up markdown code block wrappers
            //         if (responseText.startsWith('```json')) {
            //             responseText = responseText.substring(7, responseText.length - 3).trim();
            //         } else if (responseText.startsWith('```')) { // General markdown block
            //             responseText = responseText.substring(3, responseText.length - 3).trim();
            //         }

            //         try {
            //             const parsedResponse = JSON.parse(responseText);
            //             return parsedResponse; // Expecting { worksheet: "...", answerKey: "..." }
            //         } catch (parseError) {
            //             console.warn("Could not parse Gemini response as JSON. Displaying raw text.", responseText, parseError);
            //             // Fallback in case JSON parsing fails completely, just show raw text nicely
            //             return { 
            //                 worksheet: `<div style="padding: 15px; border: 1px dashed #ccc; background-color: #f9f9f9;">
            //                                 <p style="font-weight: bold; color: #d93025;">Error: Could not parse worksheet content.</p>
            //                                 <pre style="white-space: pre-wrap; word-break: break-all;">${responseText}</pre>
            //                             </div>`, 
            //                 answerKey: '<p style="text-align: center; color: #666;">Answer key unavailable due to content parsing error.</p>' 
            //             };
            //         }
            //     } else {
            //         throw new Error("No content or unexpected format found in Gemini API response.");
            //     }
            // }

            /**
             * Formats raw text content by converting newlines to <br> tags
             * and handling multiple newlines for paragraph breaks.
             * @param {string} text The raw text content from the API.
             * @returns {string} HTML string with line breaks.
             */
            function formatTextForHtml(text) {
                if (!text) return '';
                // Replace single newlines with <br> for line breaks
                // Replace double newlines with <p> tags for paragraph breaks
                return text
                    .replace(/\n{2,}/g, '</p><p>') // Multiple newlines -> paragraph break
                    .replace(/\n/g, '<br>')      // Single newline -> line break
                    .replace(/^<p>|<\/p>$/g, '') // Remove <p> if it's just from leading/trailing newlines
                    .trim(); // Remove any leading/trailing whitespace
            }

            function displayWorksheet(content) {
                // Apply the formatting function before setting innerHTML
                worksheetTabContent.innerHTML = formatTextForHtml(content.worksheet) || '<p style="text-align: center; color: #666;">No worksheet content generated.</p>';
                answerKeyTabContent.innerHTML = formatTextForHtml(content.answerKey) || '<p style="text-align: center; color: #666;">No answer key generated or requested.</p>';
            }

            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            downloadPdfBtn.addEventListener('click', async function() {
                const worksheetElement = document.getElementById('worksheetContent');
                if (!worksheetElement.innerHTML.trim() || worksheetElement.innerHTML.includes('No worksheet content generated')) {
                    alert('Please generate a worksheet first before attempting to download.');
                    return;
                }

                // Temporary message for user
                const originalBtnText = downloadPdfBtn.innerHTML;
                downloadPdfBtn.innerHTML = '<span class="material-icons btn-icon loading-spinner-small">cached</span> Generating PDF...';
                downloadPdfBtn.disabled = true; // Disable button during PDF generation

                // Add a small spinner style for the button
                const style = document.createElement('style');
                style.innerHTML = `
                    .loading-spinner-small {
                        display: inline-block;
                        width: 16px;
                        height: 16px;
                        border: 2px solid #f3f3f3;
                        border-top: 2px solid var(--white);
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        vertical-align: middle;
                        margin-right: 5px;
                    }
                `;
                document.head.appendChild(style);

                try {
                    // Use html2canvas to render the content
                    const canvas = await html2canvas(worksheetElement, {
                        scale: 2, // Increase scale for better resolution in PDF
                        useCORS: true, // Important if you have external images/fonts
                        scrollX: -window.scrollX, // Fix for horizontal scroll
                        scrollY: -window.scrollY, // Fix for vertical scroll
                        windowWidth: document.documentElement.offsetWidth,
                        windowHeight: document.documentElement.offsetHeight,
                        logging: false // Disable logging for cleaner console
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' for size

                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    // Add image to PDF
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    // If content spans multiple pages
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    // Save the PDF
                    const subject = document.getElementById('subject').value || 'Worksheet';
                    const topic = document.getElementById('topic').value || 'Generated';
                    const fileName = `${subject}_${topic}_Worksheet_${new Date().toLocaleDateString()}.pdf`;
                    pdf.save(fileName);

                } catch (error) {
                    console.error("Error generating PDF:", error);
                    alert('Failed to generate PDF. Please ensure the worksheet is visible and try again. Check console for more details.');
                } finally {
                    downloadPdfBtn.innerHTML = originalBtnText; // Restore button text
                    downloadPdfBtn.disabled = false; // Re-enable button
                    // The style tag should be removed as it's added dynamically
                    const existingStyle = document.querySelector('style:last-child');
                    if (existingStyle && existingStyle.innerHTML.includes('.loading-spinner-small')) {
                         document.head.removeChild(existingStyle);
                    }
                }
            });

            const submitModifications = document.getElementById('submitModifications');
            submitModifications.addEventListener('click', async function() {
                const modifyInstructions = document.getElementById('modifyInstructions').value;
                if (!modifyInstructions.trim()) {
                    errorMessage.textContent = 'Please enter modification instructions.';
                    errorMessage.style.display = 'block';
                    return;
                }

                errorMessage.style.display = 'none';
                loadingIndicator.style.display = 'block';
                resultsContainer.style.display = 'none';
                modifyForm.classList.remove('active'); // Hide modification form during regeneration

                try {
                    const currentFormData = {
                        gradeLevel: document.getElementById('gradeLevel').value,
                        subject: document.getElementById('subject').value,
                        topic: document.getElementById('topic').value,
                        worksheetType: document.getElementById('worksheetType').value,
                        difficulty: document.getElementById('difficulty').value,
                        questionCount: parseInt(document.getElementById('questionCount').value, 10),
                        includeAnswerKey: document.getElementById('includeAnswerKey').checked,
                        randomizeQuestions: document.getElementById('randomizeQuestions').checked,
                        files: Array.from(fileInput.files)
                    };

                    const regeneratedContent = await generateWorksheetWithGemini(currentFormData, modifyInstructions);
                    displayWorksheet(regeneratedContent);

                    loadingIndicator.style.display = 'none';
                    resultsContainer.style.display = 'block';
                    document.getElementById('modifyInstructions').value = ''; // Clear instructions
                    resultsContainer.scrollIntoView({ behavior: 'smooth' });

                } catch (err) {
                    loadingIndicator.style.display = 'none';
                    errorMessage.textContent = `An error occurred while regenerating the worksheet: ${err.message}. Please try again.`;
                    errorMessage.style.display = 'block';
                    console.error('Worksheet regeneration error:', err);
                }
            });

            // Back navigation function
            function goBackToIndex() {
                window.location.href = 'index.html';
            }
        });

        // Back navigation function - defined globally so onclick can access it
        function goBackToIndex() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>